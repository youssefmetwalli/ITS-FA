<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automata Chatbot</title>

    <!-- Your existing CSS file -->
    <link rel="stylesheet" href="/static/css/styles.css" />

    <!-- jQuery + polyfills -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- MathJax if needed -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        .chat-container {
            max-width: 70%;
            margin: 0 auto;
            background-color: #f4f4f4;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            height: 500px;
        }

        @media (min-width: 768px) {
            .chat-container {
                max-width: 600px;
            }
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 15px;
            max-width: 70%;
            word-wrap: break-word;
            display: inline-block;
        }

        .user-message {
            align-self: flex-end;
            background-color: #d4f0fc;
            color: #000;
        }

        .bot-message {
            align-self: flex-start;
            background-color: #e0f7e9;
            color: #000;
            white-space: pre-wrap;
        }


        .input-container {
            display: flex;
        }

        .input-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px 0 0 5px;
        }

        #sendButton {
            padding: 10px 16px;
            border: 1px solid #ddd;
            border-left: none;
            border-radius: 0 5px 5px 0;
            background: linear-gradient(45deg, #007bff, #009eff);
            color: #fff;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }

        #sendButton:hover {
            background: linear-gradient(45deg, #0056b3, #007ce0);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Modern styling for save, load, and clear buttons */
        #saveButton,
        #loadButton,
        #clearButton {
            display: inline-block;
            padding: 10px 20px;
            margin: 10px 5px;
            text-decoration: none;
            color: #fff;
            background: linear-gradient(45deg, #3b8ee3, #5aa9ed);
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }

        #saveButton:hover,
        #loadButton:hover,
        #clearButton:hover {
            background: linear-gradient(45deg, #3172c1, #4a8abc);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }



        /* PDF-specific styles */
        .pdf-message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            word-wrap: break-word;
            page-break-inside: avoid;
            max-width: 100%;
            /* Take full width within the pdf container */
        }

        .pdf-user-message {
            background-color: #d4f0fc;
            color: #000;
            margin-left: 0;
            /* Ensure full width in pdf output */
            margin-right: 0;
        }

        .pdf-bot-message {
            background-color: #e0f7e9;
            color: #000;
            margin-left: 0;
            margin-right: 0;
        }
    </style>
</head>

<body>
    <div class="header-container">
        <h1>Automata Chatbot</h1>
        <a class="button" href="{{ url_for('index') }}">Home</a>
        <a class="button" href="javascript:history.back()">Back</a>
    </div>

    <div class="chat-container">
        <div class="messages" id="messages"></div>

        <div class="input-container">
            <input type="text" id="userInput" placeholder="Type a message...">
            <button id="sendButton">Send</button>
        </div>

        <div>
            <button id="saveButton">Save</button>
            <button id="clearButton">Clear</button>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // Function to replace bold Markdown with HTML strong tags
            function renderBoldText(text) {
                return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            }

            // Function to simulate smooth typing effect
            function typeMessage(element, message, callback) {
                let index = 0;
                const intervalId = setInterval(() => {
                    if (index < message.length) {
                        element.html(message.substring(0, index + 1));
                        index++;
                    } else {
                        clearInterval(intervalId);
                        if (callback) callback();
                    }
                }, 20); // Adjust typing speed here (milliseconds)
            }

            // Send message on Send button or Enter key
            $('#sendButton').click(function () {
                sendMessage();
            });

            $('#userInput').on('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage();
                }
            });

            function sendMessage() {
                var userInput = $('#userInput').val().trim();
                if (userInput) {
                    // Add the user's message to chat
                    $('#messages').append(
                        '<div class="message user-message">' + escapeHtml(userInput) + '</div>'
                    );
                    $('#userInput').val('');

                    // AJAX call to your server endpoint
                    $.ajax({
                        url: '/chat_api',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ message: userInput }),
                        success: function (response) {
                            if (response.error) {
                                alert(response.error);
                            } else {
                                // Render bold text using the function
                                var botContainer = $('<div class="message bot-message"></div>');
                                $('#messages').append(botContainer);

                                var messageText = renderBoldText(response.message);
                                // Apply typing effect to the response
                                typeMessage($('.bot-message:last-child'), messageText, function () {
                                    // Auto-scroll to bottom after message is displayed
                                    $('#messages').scrollTop($('#messages')[0].scrollHeight);
                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            alert('Error: ' + error);
                        }
                    });
                }
            }

            // Save to PDF functionality
            $('#saveButton').click(async function () {
                const pdfName = prompt("Enter a name for your PDF file:", "chat_history");
                if (pdfName) {
                    try {
                        // Create a temporary div for PDF conversion
                        const pdfContainer = document.createElement('div');
                        pdfContainer.style.width = '800px';  // Fixed width for PDF
                        pdfContainer.style.padding = '20px';

                        // Get all messages and clone them with PDF-specific styling
                        const messages = document.querySelectorAll('.message');
                        messages.forEach(msg => {
                            const pdfMessage = document.createElement('div');
                            pdfMessage.innerHTML = msg.innerHTML;
                            pdfMessage.className = 'pdf-message';

                            if (msg.classList.contains('user-message')) {
                                pdfMessage.classList.add('pdf-user-message');
                            } else {
                                pdfMessage.classList.add('pdf-bot-message');
                            }

                            pdfContainer.appendChild(pdfMessage);
                        });

                        // Temporarily add the container to the document
                        document.body.appendChild(pdfContainer);

                        // Convert to canvas
                        const canvas = await html2canvas(pdfContainer, {
                            scale: 2,
                            logging: false,
                            useCORS: true
                        });

                        // Remove temporary container
                        document.body.removeChild(pdfContainer);

                        // Initialize PDF
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF({
                            orientation: 'portrait',
                            unit: 'mm',
                            format: 'a4'
                        });

                        // Calculate dimensions
                        const imgWidth = 210; // A4 width in mm
                        const pageHeight = 295; // A4 height in mm
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        let heightLeft = imgHeight;
                        let position = 0;

                        // Add image to PDF
                        const imgData = canvas.toDataURL('image/png');
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;

                        // Add new pages if needed
                        while (heightLeft >= 0) {
                            position = heightLeft - imgHeight;
                            pdf.addPage();
                            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            heightLeft -= pageHeight;
                        }

                        // Save PDF
                        pdf.save(pdfName + '.pdf');
                    } catch (error) {
                        console.error('Error generating PDF:', error);
                        alert('Error generating PDF. Please try again.');
                    }
                }
            });


            // Clear the conversation
            $('#clearButton').click(function () {
                $('#messages').html('');
            });

            // Simple HTML-escape function for user text
            function escapeHtml(text) {
                return text
                    .replace(/&/g, "&")
                    .replace(/</g, "<")
                    .replace(/>/g, ">");
            }
        });
    </script>
</body>

</html>